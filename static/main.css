// static/js/progreso.js
document.addEventListener("DOMContentLoaded", () => {
  // Obtenemos el ID del job desde el atributo data‑jid del <section>
  const container = document.querySelector("section[data-jid]");
  if (!container) return;

  const jid     = container.dataset.jid;
  const circle  = container.querySelector(".fg");
  const pctTxt  = container.querySelector("#pct");
  const msgTxt  = container.querySelector("#msg");

  // Circunferencia = 2πr  → con r=54 (en SVG) son 339.292
  const CIRC = 2 * Math.PI * 54;

  function updateGauge(pct) {
    const offset = CIRC - (pct / 100) * CIRC;
    circle.style.strokeDashoffset = offset;
    pctTxt.textContent = `${pct}%`;
  }

  function setMessage(txt) {
    msgTxt.textContent = txt;
  }

  // SSE para progreso
  const es = new EventSource(`/events/${jid}`);

  es.onmessage = (ev) => {
    const { pct, msg, finished } = JSON.parse(ev.data);

    updateGauge(pct);
    setMessage(msg);

    if (finished) {
      es.close();                               // evita reconexiones
      window.location.href = `/resultado/${jid}`;
    }
  };

  es.onerror = () => {
    console.warn("SSE connection lost, retrying automatically…");
  };
});
