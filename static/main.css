/* static/js/progreso.js */

document.addEventListener("DOMContentLoaded", () => {
  const jid  = document.body.dataset.jid;           // se lo pasas en la plantilla
  const bar  = document.querySelector("#circle");   // tu componente de progreso
  const text = document.querySelector("#pct");
  const desc = document.querySelector("#msg");

  function updateGauge(pct) {
    // Ejemplo con ProgressBar.js; ajusta a tu librería
    bar.style.setProperty("--value", pct);          // si usas CSS custom
    text.textContent = `${pct}%`;
  }

  function setMessage(msg) {
    desc.textContent = msg;
  }

  const es = new EventSource(`/events/${jid}`);

  es.onmessage = (ev) => {
    const { pct, msg, finished } = JSON.parse(ev.data);
    updateGauge(pct);
    setMessage(msg);

    if (finished) {
      es.close();                                   // evita reconexiones
      window.location.href = `/resultado/${jid}`;   // salto a la tabla
    }
  };

  es.onerror = () => {
    // En caso de corte de red, déjalo reconectar solo
    console.warn("SSE connection lost, retrying…");
  };
});
